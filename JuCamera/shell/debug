#æ‰“åŒ…çŽ¯å¢ƒ  app-store, ad-hoc, enterprise, development

#æœ€å¼€å§‹è·¯å¾„å·¥ç¨‹ç»å¯¹è·¯å¾„
base_Path=$(pwd)

#èŽ·å–shell Infoæ–‡ä»¶

CONFIG_INFO_PATH=$base_Path/config.plist
#å·¥ç¨‹å
workspace_name=$(/usr/libexec/PlistBuddy -c "Print workspace" "$CONFIG_INFO_PATH")
workspace_path=$(cd ..;pwd)

echo "å½“å‰è„šæœ¬è·¯å¾„ ${base_Path}"

#workspaceè·¯å¾„
project_path=$(cd $workspace_path ;pwd)
echo "å½“å‰å·¥ç¨‹è·¯å¾„ ${project_path}"

#èŽ·å–shell Infoæ–‡ä»¶
project_name=$(/usr/libexec/PlistBuddy -c "Print project" "$CONFIG_INFO_PATH")
if [ ! -n "$project_name" ];then
 project_name=$workspace_name
fi

scheme_name=$(/usr/libexec/PlistBuddy -c "Print scheme" "$CONFIG_INFO_PATH")
if [ ! -n "$scheme_name" ];then
 scheme_name=$project_name
fi

ipa_name=$(/usr/libexec/PlistBuddy -c "Print ipaname" "$CONFIG_INFO_PATH")
if [ ! -n "$ipa_name" ];then
    ipa_name=$project_name
fi

#æ‰“åŒ…æ¨¡å¼ Debug/Release
echo "è¯·è¾“å…¥ç¼–è¯‘çŽ¯å¢ƒ 0-sit 1-uat 2-release"
read compileNum
while([ $compileNum != 0 ] && [ $compileNum != 1 ]&& [ $compileNum != 2 ] && [ $compileNum != -1 ])
do
echo "Error! Should enter 0 or 1 or 2"
echo "Place enter the number you want to export ? [ 1:sit 2:uat 3:release] "
read number
done


#æ·»åŠ è¯ä¹¦
if [ $compileNum == -1 ];then
APIEIR="dev"
elif [ $compileNum == 0 ];then
APIEIR="sit"
elif [ $compileNum == 1 ];then
APIEIR="uat"
else
APIEIR="release"
fi

development_mode=Debug


#èµ„æºè·¯å¾„
resource_path=${base_Path}/package/$(date +%Y-%m-%d)
#buildæ–‡ä»¶å¤¹è·¯å¾„
build_path=$resource_path/build/${development_mode}



APPAPI_CONFIG="$compileNum:$APIEIR"

echo '***  ä¿®æ”¹çŽ¯å¢ƒé…ç½®æ–‡ä»¶ '
PRODUCT_API_PATH=$project_path/$project_name/api.dat
cat  > ${PRODUCT_API_PATH} << EOF
$APPAPI_CONFIG
EOF
echo '***   ä¿®æ”¹çŽ¯å¢ƒé…ç½®æ–‡ä»¶æˆåŠŸ '



#æ‰“åŒ…æ¨¡å¼ Debug/Release
echo "è¯·é€‰æ‹©è¯ä¹¦çŽ¯å¢ƒ  1-developer 2-Enterprise"
read number
while([ $number != 1 ] && [ $number != 2 ])
do
echo "Error! Should enter 1 or 2"
echo "Place enter the number you want to export ? [ 1:test 2:Enterprise] "
read number
done


#æ·»åŠ è¯ä¹¦
if [ $number == 1 ];then
export_Key="development"
Code_Sign="iPhone Developer"
IpaSuffix="$APIEIR"
else
export_Key="enterprise-Debug"

testExport=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}" "$CONFIG_INFO_PATH")

if [ ! -n "$testExport" ];then
    export_Key="enterprise"
fi

Code_Sign="iPhone Distribution"
IpaSuffix="enterprise_$APIEIR"
fi


#echo "è·¯å¾„ $build_path"
#ä¿®æ”¹Infoæ–‡ä»¶
PRODUCT_INFO_PATH=$project_path/$project_name/Info.plist
BuildVersion=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$PRODUCT_INFO_PATH")
appVersion=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$PRODUCT_INFO_PATH")
bundleId=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$PRODUCT_INFO_PATH")
echo '***BuildVersion  '${BuildVersion}
echo '***appVersion  ' ${appVersion}

#ç¦ç”¨æš—é»‘æ¨¡å¼
/usr/libexec/PlistBuddy -c 'Add :UIUserInterfaceStyle string "Light"' "$PRODUCT_INFO_PATH"

echo '*** æ­£åœ¨ ä¿®æ”¹ATS' ${ATSSet}
# å¦‚æžœè¿˜ä¸å­˜åœ¨å­—å…¸ï¼Œåˆ™å…ˆæ·»åŠ å­—å…¸å®¹å™¨ï¼šæ·»åŠ dictçš„keyå€¼   dictkey
/usr/libexec/PlistBuddy -c 'Delete :NSAppTransportSecurity' "$PRODUCT_INFO_PATH"
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity  dict' "$PRODUCT_INFO_PATH"
# æ·»åŠ keyï¼švalueå¯¹ï¼Œå¦‚æžœå·²ç»å­˜åœ¨å­—å…¸ï¼Œä¸éœ€è¦ç»è¿‡ä¸Šä¸€æ­¥
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool true' "$PRODUCT_INFO_PATH"
echo '***  ä¿®æ”¹ATSæˆåŠŸ ' ${ATSSet}

Entitlements=$project_path/${project_name}/${scheme_name}.entitlements

#æŽ¨é€é…ç½®
/usr/libexec/PlistBuddy -c 'Delete :aps-environment' "$Entitlements"
aps_environment=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:aps-environment" "$CONFIG_INFO_PATH")
if [  -n "$aps_environment" ];then
/usr/libexec/PlistBuddy -c 'Add :aps-environment string "development" ' "$Entitlements"
fi

#æ·»åŠ è‹¹æžœç™»å½•(å…ˆåˆ é™¤)
/usr/libexec/PlistBuddy -c 'Delete :com.apple.developer.applesignin' "$Entitlements"
applesignin=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:applesignin" "$CONFIG_INFO_PATH")
if [  -n "$applesignin" ];then
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.applesignin  array' "$Entitlements"
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.applesignin: string Default' "$Entitlements"
fi


#linké…ç½®
/usr/libexec/PlistBuddy -c 'Delete :com.apple.developer.associated-domains' "$Entitlements"
associated_domains=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:associated-domains" "$CONFIG_INFO_PATH")
if [  -n "$associated_domains" ];then
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.associated-domains  array' "$Entitlements"
/usr/libexec/PlistBuddy -c "Add :com.apple.developer.associated-domains: string $associated_domains" "$Entitlements"
fi


#èŽ·å–BuildSetting é…ç½®
projectFile=${project_path}/${project_name}.xcodeproj/project.pbxproj
echo "å·¥ç¨‹é…ç½®æ–‡ä»¶$projectFile"

function getBuildSettingsConfigure
{
    echo "å·¥ç¨‹é…ç½®æ–‡ä»¶$projectFile"
#    projectFile="/Users/zhutianwei224/Desktop/TeshDebug/TeshDebug.xcodeproj/project.pbxproj"
    rootObject=$(/usr/libexec/PlistBuddy -c "Print :rootObject" $projectFile)
    targetList=$(/usr/libexec/PlistBuddy -c "Print :objects:${rootObject}:targets" $projectFile | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
    targets=(`echo $targetList`);#æ‹¬å·ç”¨äºŽåˆå§‹åŒ–æ•°ç»„,ä¾‹å¦‚arr=(1,2,3)
    for targetId in ${targets[@]}; do
        targetName=$(/usr/libexec/PlistBuddy -c "Print :objects:$targetId:name" $projectFile)
        buildTargetNames=(${buildTargetNames[*]} $targetName)
        buildConfigurationListId=$(/usr/libexec/PlistBuddy -c "Print :objects:$targetId:buildConfigurationList" $projectFile)
        buildConfigurationList=$(/usr/libexec/PlistBuddy -c "Print :objects:$buildConfigurationListId:buildConfigurations" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
        buildConfigurations=(`echo $buildConfigurationList`)

        for configurationId in ${buildConfigurations[@]}; do
            echo "=============================="
            echo "å¼€å§‹è¯»å–é…ç½®$configurationId"
            configurationName=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:name" "$projectFile")

           if [ "$development_mode" == "$configurationName" ];then
           ##èŽ·å–ç‰ˆæœ¬å·
                if [ "$appVersion" == '$(MARKETING_VERSION)' ];then
                    appVersion=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:MARKETING_VERSION" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
                fi
                ##èŽ·å–bu
                if [ "$BuildVersion" == '$(CURRENT_PROJECT_VERSION)' ];then
                    BuildVersion=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:CURRENT_PROJECT_VERSION" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')


                fi
                
                ##èŽ·å–BundleId
                if [ "$bundleId" == '$(PRODUCT_BUNDLE_IDENTIFIER)' ];then
                    bundleId=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:PRODUCT_BUNDLE_IDENTIFIER" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
                    #        ä¿®æ”¹bundleId
                    if [ -n "$exBundleid" ]; then
                        /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:PRODUCT_BUNDLE_IDENTIFIER $exBundleid" "$projectFile"
                        bundleId=$exBundleid
                    fi
                fi
                
                if [ -n "$exProfile" ]; then
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:PROVISIONING_PROFILE_SPECIFIER $exProfile" "$projectFile"
                        bundleId=$exBundleid
                fi
                  
                if [ -n "$teamID" ]; then
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:DEVELOPMENT_TEAM $teamID" "$projectFile"
                        bundleId=$exBundleid
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:CODE_SIGN_IDENTITY $Code_Sign" "$projectFile"
                        bundleId=$exBundleid
                fi
                echo "appVersion:$appVersion $BuildVersion $bundleId"
          fi
        done
    done
}


ExportOptions_path=$base_Path/ExportOptions.plist

method=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:method" "$CONFIG_INFO_PATH")
exBundleid=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:bundleID" "$CONFIG_INFO_PATH")
exProfile=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:profile" "$CONFIG_INFO_PATH")
teamID=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:teamID" "$CONFIG_INFO_PATH")

echo "è¯ä¹¦è·¯å¾„ $ExportOptions_path"

getBuildSettingsConfigure


echo '*** è®¾ç½®ExportOptions '${ExportOptions_path}
/usr/libexec/PlistBuddy -c "Set :method  ${method}" "$ExportOptions_path"
/usr/libexec/PlistBuddy -c 'Delete :provisioningProfiles' "$ExportOptions_path"
/usr/libexec/PlistBuddy -c "Add :provisioningProfiles:${bundleId} string ${exProfile}" "$ExportOptions_path"
/usr/libexec/PlistBuddy -c "Set :teamID  ${teamID}" "$ExportOptions_path"

echo '***  ä¿®æ”¹ExportOptionså·æˆåŠŸ '

#if [ $BuildVersion <= 0 ];then
#    NewBuildVersion="1"
#else
    NewBuildVersion=`expr $BuildVersion + 1`
#fi

echo '*** æ­£åœ¨ ä¿®æ”¹buildå· '${NewBuildVersion}
echo '*** buildä¿®æ”¹æˆ '${NewBuildVersion}
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NewBuildVersion" "$PRODUCT_INFO_PATH"
echo '***  ä¿®æ”¹buildå·æˆåŠŸâœ…âœ…âœ… '

oldAppName=$(/usr/libexec/PlistBuddy -c "Print CFBundleDisplayName" "$PRODUCT_INFO_PATH")
appname=$(/usr/libexec/PlistBuddy -c "Print appname" "$CONFIG_INFO_PATH")
if [  -n "$appname" ];then
    if [ $compileNum == 2 ];then
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $appname" "$PRODUCT_INFO_PATH"
    else
        echo "APPåˆå§‹åå­—ï¼š$oldAppName"
        newAppName="$APIEIR$appname"
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $newAppName" "$PRODUCT_INFO_PATH"
        echo "APPåå­—ä¿®æ”¹ä¸º:$newAppName âœ…"
    fi
fi

echo '*** æ­£åœ¨ æ¸…ç†å·¥ç¨‹ ***'
xcodebuild \
clean -project ${project_path}/${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${development_mode} -quiet  || exit
echo '*** æ¸…ç†å®Œæˆâœ…âœ…âœ… ***'


echo '*** æ­£åœ¨ ç¼–è¯‘å·¥ç¨‹ For '${development_mode}
xcodebuild \
archive -workspace ${workspace_path}/${workspace_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${development_mode} \
-archivePath ${build_path}/${project_name}.xcarchive -quiet  || exit
echo '*** ç¼–è¯‘å®Œæˆâœ…âœ…âœ… ***'

#æ”¹å›žåŽŸå§‹åç§°
if [  -n "$appname" ];then
    /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $appname" "$PRODUCT_INFO_PATH"
fi

exportFilePath=$resource_path/ipa/${development_mode}


echo '*** æ­£åœ¨ æ‰“åŒ… ***'
buildIpa(){
    xcodebuild -exportArchive -archivePath ${build_path}/${project_name}.xcarchive \
    -configuration ${development_mode} \
    -exportPath $1 \
    -exportOptionsPlist $2 \
    -quiet || exit
}

buildIpa ${exportFilePath} ${ExportOptions_path}

#åŒ…å
ipaPath="${exportFilePath}/${project_name}.ipa"


if [ -e $ipaPath ]; then
echo "*** .ipaæ–‡ä»¶å·²å¯¼å‡ºâœ…âœ…âœ… ${ipaPath}***"
open $exportFilePath
else
echo "*** åˆ›å»º.ipaæ–‡ä»¶å¤±è´¥âŒâŒâŒ ***"
fi
echo '*** æ‰“åŒ…å®Œæˆ ***'

#æ—¶é—´
ipaDate=$(date +%Y%m%d)

renameIpa="${exportFilePath}/iOS_${ipa_name}_${appVersion}(${NewBuildVersion})_${ipaDate}_${IpaSuffix}.ipa"
#é‡å‘½å
mv $ipaPath $renameIpa


function uploadIpa(){
    PGY_API_KEY=$(/usr/libexec/PlistBuddy -c "Print uploadkey" "$CONFIG_INFO_PATH")
    PGY_HOST=$(/usr/libexec/PlistBuddy -c "Print uploadhost" "$CONFIG_INFO_PATH")
    #APK_PATH="/Users/zhangyunzhen171/work/project/newJZ/cgj-channel-car-ios/shell/package/2022-02-23/ipa/Debug"
    if [ ! -n "$PGY_API_KEY"  ];then
        echo "è¯·é…ç½®ä¸Šä¼ keyå’ŒhostâŒâŒâŒ"
    else
        echo "ä¸Šä¼ é…ç½® ${PGY_API_KEY} ${PGY_HOST}"
        #APK_PATH="/Users/zhangyunzhen171/work/project/newJZ/cgj-channel-car-ios/shell/package/2022-02-23/ipa/Debug"

        #upload pgy
        echo "*************************  æ­£åœ¨ä¸Šä¼ ipaåŒ… ðŸš€ ðŸš€ ðŸš€  *************************"
#        curl -F "file=@${renameIpa}" -F "_api_key=${PGY_API_KEY}" -FÂ "buildUpdateDescription=${APIEIR}çŽ¯å¢ƒ" ${PGY_HOST}
        curl -F "file=@${renameIpa}" -F "_api_key=${PGY_API_KEY}" ${PGY_HOST}
        echo "************************* âœ…âœ…âœ…Success. Total time: ${SECONDS}s ðŸŽ‰  ðŸŽ‰  ðŸŽ‰ *************************"
    fi
}




#æ·»åŠ è¯ä¹¦
if ([ $compileNum != -1 ]&& [ $number != 1 ]);then
    uploadIpa
else
    echo "ä¸ä¸Šä¼ åŒ…"
fi
