#æ‰“åŒ…ç¯å¢ƒ  app-store, ad-hoc, enterprise, development

#æœ€å¼€å§‹è·¯å¾„å·¥ç¨‹ç»å¯¹è·¯å¾„
base_Path=$(pwd)

#è·å–shell Infoæ–‡ä»¶

CONFIG_INFO_PATH=$base_Path/config.plist
#å·¥ç¨‹å
workspace_name=$(/usr/libexec/PlistBuddy -c "Print workspace" "$CONFIG_INFO_PATH")
workspace_path=$(cd ..;pwd)

#è·å–shell Infoæ–‡ä»¶

project_name=$(/usr/libexec/PlistBuddy -c "Print project" "$CONFIG_INFO_PATH")
if [ ! -n "$project_name"  ];then
 project_name=$workspace_name
fi

scheme_name=$(/usr/libexec/PlistBuddy -c "Print scheme" "$CONFIG_INFO_PATH")
if [ ! -n "$scheme_name"  ];then
 scheme_name=$project_name
fi

ipa_name=$(/usr/libexec/PlistBuddy -c "Print ipaname" "$CONFIG_INFO_PATH")
if [ ! -n "$ipa_name" ];then
    ipa_name=$project_name
fi

echo "é…ç½®  $workspace_name $project_name $ipa_name"
#æ‰“åŒ…æ¨¡å¼ Debug/Release
echo "è¯·é€‰æ‹©è¯ä¹¦ç¯å¢ƒ  1-AppStore 2-ad-hoc 3-Enterprise"
read number
while([[ $number != 1 ]] && [[ $number != 2 ]]&& [[ $number != 3 ]])
do
echo "Error! Should enter 1 or 2"
echo "Place enter the number you want to export ? [ 1:AppStore 2:Enterprise] "
read number
done


APIEIR="publish"

development_mode=Release

#æ·»åŠ è¯ä¹¦
if [ $number == 1 ];then
export_Key="app-store"
IpaSuffix="$APIEIR"
elif [ $number == 1 ];then
export_Key="ad-hoc"
IpaSuffix="Hoc_$APIEIR"
else
export_Key="enterprise-Release"
testExport=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}" "$CONFIG_INFO_PATH")

if [ ! -n "$testExport" ];then
    export_Key="enterprise"
fi

IpaSuffix="enterprise_$APIEIR"
fi

Code_Sign="iPhone Distribution"

#workspaceè·¯å¾„
project_path=$(cd $workspace_path ;pwd)
#èµ„æºè·¯å¾„
resource_path=${base_Path}/package/$(date +%Y-%m-%d)
#buildæ–‡ä»¶å¤¹è·¯å¾„
build_path=$resource_path/build/${development_mode}



#echo "è·¯å¾„ $build_path"
#ä¿®æ”¹Infoæ–‡ä»¶
PRODUCT_INFO_PATH=$project_path/$project_name/Info.plist
BuildVersion=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$PRODUCT_INFO_PATH")
appVersion=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$PRODUCT_INFO_PATH")
bundleId=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$PRODUCT_INFO_PATH")

echo '***BuildVersion  '${BuildVersion}
echo '***appVersion  ' ${appVersion}

#ç¦ç”¨æš—é»‘æ¨¡å¼
/usr/libexec/PlistBuddy -c 'Add :UIUserInterfaceStyle string "Light"' "$PRODUCT_INFO_PATH"

echo '*** æ­£åœ¨ ä¿®æ”¹ATS' ${ATSSet}
# å¦‚æœè¿˜ä¸å­˜åœ¨å­—å…¸ï¼Œåˆ™å…ˆæ·»åŠ å­—å…¸å®¹å™¨ï¼šæ·»åŠ dictçš„keyå€¼   dictkey
/usr/libexec/PlistBuddy -c 'Delete :NSAppTransportSecurity' "$PRODUCT_INFO_PATH"
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity  dict' "$PRODUCT_INFO_PATH"
# æ·»åŠ keyï¼švalueå¯¹ï¼Œå¦‚æœå·²ç»å­˜åœ¨å­—å…¸ï¼Œä¸éœ€è¦ç»è¿‡ä¸Šä¸€æ­¥
if [ $number == 1 ];then
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool false' "$PRODUCT_INFO_PATH"
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity:NSAllowsArbitraryLoadsInWebContent bool true' "$PRODUCT_INFO_PATH"
else
/usr/libexec/PlistBuddy -c 'Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool true' "$PRODUCT_INFO_PATH"
fi
echo '***  ä¿®æ”¹ATSæˆåŠŸ ' ${ATSSet}

Entitlements=$project_path/${project_name}/${scheme_name}.entitlements

#æ¨é€é…ç½®
/usr/libexec/PlistBuddy -c 'Delete :aps-environment' "$Entitlements"
aps_environment=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:aps-environment" "$CONFIG_INFO_PATH")
if [  -n "$aps_environment" ];then
/usr/libexec/PlistBuddy -c 'Add :aps-environment string "development" ' "$Entitlements"
fi

#æ·»åŠ è‹¹æœç™»å½•(å…ˆåˆ é™¤)
/usr/libexec/PlistBuddy -c 'Delete :com.apple.developer.applesignin' "$Entitlements"
applesignin=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:applesignin" "$CONFIG_INFO_PATH")
if [  -n "$applesignin" ];then
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.applesignin  array' "$Entitlements"
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.applesignin: string Default' "$Entitlements"
fi


#linké…ç½®
/usr/libexec/PlistBuddy -c 'Delete :com.apple.developer.associated-domains' "$Entitlements"
associated_domains=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:associated-domains" "$CONFIG_INFO_PATH")
if [  -n "$associated_domains" ];then
/usr/libexec/PlistBuddy -c 'Add :com.apple.developer.associated-domains  array' "$Entitlements"
/usr/libexec/PlistBuddy -c "Add :com.apple.developer.associated-domains: string $associated_domains" "$Entitlements"
fi


#è·å–BuildSetting é…ç½®
projectFile=${project_path}/${project_name}.xcodeproj/project.pbxproj
echo "å·¥ç¨‹é…ç½®æ–‡ä»¶$projectFile"
function getBuildSettingsConfigure
{
    echo "å·¥ç¨‹é…ç½®æ–‡ä»¶$projectFile"
#    projectFile="/Users/zhutianwei224/Desktop/TeshDebug/TeshDebug.xcodeproj/project.pbxproj"
    rootObject=$(/usr/libexec/PlistBuddy -c "Print :rootObject" $projectFile)
    targetList=$(/usr/libexec/PlistBuddy -c "Print :objects:${rootObject}:targets" $projectFile | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
    targets=(`echo $targetList`);#æ‹¬å·ç”¨äºåˆå§‹åŒ–æ•°ç»„,ä¾‹å¦‚arr=(1,2,3)
    echo "å‘ç°targets(id): $targets"
    for targetId in ${targets[@]}; do
        targetName=$(/usr/libexec/PlistBuddy -c "Print :objects:$targetId:name" $projectFile)
        buildTargetNames=(${buildTargetNames[*]} $targetName)
        buildConfigurationListId=$(/usr/libexec/PlistBuddy -c "Print :objects:$targetId:buildConfigurationList" $projectFile)
        buildConfigurationList=$(/usr/libexec/PlistBuddy -c "Print :objects:$buildConfigurationListId:buildConfigurations" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
        buildConfigurations=(`echo $buildConfigurationList`)

        for configurationId in ${buildConfigurations[@]}; do
            echo "=============================="
            echo "å¼€å§‹è¯»å–é…ç½®$configurationId"
            configurationName=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:name" "$projectFile")

           if [ "$development_mode" == "$configurationName" ];then
           ##è·å–ç‰ˆæœ¬å·
                if [ "$appVersion" == '$(MARKETING_VERSION)' ];then
                    appVersion=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:MARKETING_VERSION" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
                fi
                ##è·å–bu
                if [ "$BuildVersion" == '$(CURRENT_PROJECT_VERSION)' ];then
                
                    BuildVersion=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:CURRENT_PROJECT_VERSION" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
                fi
                ##è·å–BundleId
                if [ "$bundleId" == '$(PRODUCT_BUNDLE_IDENTIFIER)' ];then
                    bundleId=$(/usr/libexec/PlistBuddy -c "Print :objects:$configurationId:buildSettings:PRODUCT_BUNDLE_IDENTIFIER" "$projectFile" | sed -e '/Array {/d' -e '/}/d' -e 's/^[ \t]*//')
                    #        ä¿®æ”¹bundleId
                    if [ -n "$exBundleid" ]; then
                        /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:PRODUCT_BUNDLE_IDENTIFIER $exBundleid" "$projectFile"
                        bundleId=$exBundleid
                    fi
                fi
                
                if [ -n "$exProfile" ]; then
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:PROVISIONING_PROFILE_SPECIFIER $exProfile" "$projectFile"
                        bundleId=$exBundleid
                fi
                  
                if [ -n "$teamID" ]; then
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:DEVELOPMENT_TEAM $teamID" "$projectFile"
                        bundleId=$exBundleid
                    /usr/libexec/PlistBuddy -c "Set :objects:$configurationId:buildSettings:CODE_SIGN_IDENTITY $Code_Sign" "$projectFile"
                        bundleId=$exBundleid
                fi
                
                echo "appVersion:$appVersion $BuildVersion"
          fi
        done
    done
}

ExportOptions_path=$base_Path/ExportOptions.plist

method=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:method" "$CONFIG_INFO_PATH")
exBundleid=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:bundleID" "$CONFIG_INFO_PATH")
exProfile=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:profile" "$CONFIG_INFO_PATH")
teamID=$(/usr/libexec/PlistBuddy -c "Print ${export_Key}:teamID" "$CONFIG_INFO_PATH")

echo "è¯ä¹¦è·¯å¾„ $ExportOptions_path"


getBuildSettingsConfigure


echo '*** è®¾ç½®ExportOptions '${ExportOptions_path}
/usr/libexec/PlistBuddy -c "Set :method  ${method}" "$ExportOptions_path"
/usr/libexec/PlistBuddy -c 'Delete :provisioningProfiles' "$ExportOptions_path"
/usr/libexec/PlistBuddy -c "Add :provisioningProfiles:${bundleId} string ${exProfile}" "$ExportOptions_path"
/usr/libexec/PlistBuddy -c "Set :teamID  ${teamID}" "$ExportOptions_path"

echo '***  ä¿®æ”¹ExportOptionså·æˆåŠŸ '

#if [ $BuildVersion <= 0 ];then
#    NewBuildVersion="1"
#else
    NewBuildVersion=`expr $BuildVersion + 1`
#fi

echo '*** æ­£åœ¨ ä¿®æ”¹buildå· '${NewBuildVersion}

echo '*** buildä¿®æ”¹æˆ '${NewBuildVersion}
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NewBuildVersion" "$PRODUCT_INFO_PATH"
echo '***  ä¿®æ”¹buildå·æˆåŠŸâœ…âœ…âœ… '

appname=$(/usr/libexec/PlistBuddy -c "Print appname" "$CONFIG_INFO_PATH")
if [  -n "$appname" ];then
    /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $appname" "$PRODUCT_INFO_PATH"
    echo "APPåå­—ä¿®æ”¹ä¸º:$appnameâœ…"
fi

echo '*** æ­£åœ¨ æ¸…ç†å·¥ç¨‹ ***'
xcodebuild \
clean -project ${project_path}/${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${development_mode} -quiet  || exit
echo '*** æ¸…ç†å®Œæˆâœ…âœ…âœ… ***'


echo '*** æ­£åœ¨ ç¼–è¯‘å·¥ç¨‹ For '${development_mode}
xcodebuild \
archive -workspace ${workspace_path}/${workspace_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${development_mode} \
-archivePath ${build_path}/${project_name}.xcarchive -quiet  || exit
echo '*** ç¼–è¯‘å®Œæˆâœ…âœ…âœ… ***'


exportFilePath=$resource_path/ipa/${development_mode}


echo '*** æ­£åœ¨ æ‰“åŒ… ***'
buildIpa(){
    xcodebuild -exportArchive -archivePath ${build_path}/${project_name}.xcarchive \
    -configuration ${development_mode} \
    -exportPath $1 \
    -exportOptionsPlist $2 \
    -quiet || exit
}

buildIpa ${exportFilePath} ${ExportOptions_path}

#åŒ…å
ipaPath="${exportFilePath}/${project_name}.ipa"


if [ -e $ipaPath ]; then
echo "*** .ipaæ–‡ä»¶å·²å¯¼å‡ºâœ…âœ…âœ… ${ipaPath}***"
open $exportFilePath
else
echo "*** åˆ›å»º.ipaæ–‡ä»¶å¤±è´¥ ***"
fi
echo '*** æ‰“åŒ…å®Œæˆâœ…âœ…âœ… ***'

#æ—¶é—´
ipaDate=$(date +%Y%m%d)

renameIpa="${exportFilePath}/iOS_${ipa_name}_${appVersion}(${NewBuildVersion})_${ipaDate}_${IpaSuffix}.ipa"
#é‡å‘½å
mv $ipaPath $renameIpa




#å‘å¸ƒåˆ°App Store
function uploadAppstore(){
    #APPID
    appleid=$(/usr/libexec/PlistBuddy -c "Print appid" "$CONFIG_INFO_PATH")
    applepassword=$(/usr/libexec/PlistBuddy -c "Print password" "$CONFIG_INFO_PATH")
    
    if [ ! -n "$appleid"  ];then
        echo "è¯·é…ç½®ä¸Šä¼ appleidå’ŒapplepasswordâŒâŒâŒ"
    else
        #upload iTunesConnect
        osascript -e 'display notification "Start release To AppStore" with title "Validate Start!"'
        altoolPath="/Applications/Xcode.app/Contents/Applications/Application Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Versions/A/Support/altool"
        xcrun altool --validate-app -f $renameIpa -t iOS -u $appleid -p $applepassword
        xcrun altool --upload-app -f $renameIpa -t iOS -u $appleid -p $applepassword
     fi
}

function uploadIpa(){
    PGY_API_KEY=$(/usr/libexec/PlistBuddy -c "Print uploadkey" "$CONFIG_INFO_PATH")
    PGY_HOST=$(/usr/libexec/PlistBuddy -c "Print uploadhost" "$CONFIG_INFO_PATH")
    #APK_PATH="/Users/zhangyunzhen171/work/project/newJZ/cgj-channel-car-ios/shell/package/2022-02-23/ipa/Debug"

    if [ ! -n "$PGY_API_KEY"  ];then
        echo "è¯·é…ç½®ä¸Šä¼ keyå’ŒhostâŒâŒâŒ"
    else
        echo "ä¸Šä¼ é…ç½® ${PGY_API_KEY} ${PGY_HOST}"
        #APK_PATH="/Users/zhangyunzhen171/work/project/newJZ/cgj-channel-car-ios/shell/package/2022-02-23/ipa/Debug"

        #upload pgy
        echo "*************************  æ­£åœ¨ä¸Šä¼ ipaåŒ… ğŸš€ ğŸš€ ğŸš€  *************************"
#        curl -F "file=@${renameIpa}" -F "_api_key=${PGY_API_KEY}" -FÂ "buildUpdateDescription=${APIEIR}ç¯å¢ƒ" ${PGY_HOST}
        curl -F "file=@${renameIpa}" -F "_api_key=${PGY_API_KEY}" ${PGY_HOST}
        echo "************************* âœ…âœ…âœ…Success. Total time: ${SECONDS}s ğŸ‰  ğŸ‰  ğŸ‰ *************************"
    fi
}

if [ $number == 1 ];then
echo '/// å¼€å§‹å‘å¸ƒipaåŒ… '
    uploadAppstore
    echo "***å‘å¸ƒå®Œæˆ ***"
elif [ $number == 3 ];then
    uploadIpa
else
    echo ""
fi
